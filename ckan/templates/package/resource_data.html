{% extends "package/resource_edit_base.html" %}

{% block subtitle %}{{ h.dataset_display_name(pkg) }} - {{ h.resource_display_name(res) }}{% endblock %}

{% block primary_content_inner %}

  {% set action = h.url_for(controller='ckanext.datapusher.plugin:ResourceDataController', action='resource_data', id=pkg.name, resource_id=res.id) %}
  {% set show_table = true %}

  <form method="post" action="{{ action }}" >
    <button class="btn btn-primary" name="save" type="submit">
      <i class="icon-cloud-upload"></i> {{ _('Upload to DataStore') }}
    </button>
  </form>

  {% if status.error and status.error.message %}
    {% set show_table = false %}
    <div class="alert alert-error">
      <strong>{{ _('Upload error:') }}</strong> {{ status.error.message }}
    </div>
  {% elif status.task_info and status.task_info.error %}
    <div class="alert alert-error">
      {% if status.task_info.error.message %}
        <strong>{{ _('Error:') }}</strong> {{ status.task_info.error.message }}
      {% else %}
        <strong>{{ _('Error:') }}</strong> {{ status.task_info.error }}
      {% endif %}

    </div>
  {% endif %}

  <table class="table table-bordered" data-module="table-toggle-more">
    <colgroup>
      <col width="150">
      <col>
    </colgroup>
    <tr>
      <th>{{ _('Status') }}</th>
      <td>{{ h.datapusher_status_description(status) }}</td>
    </tr>
    <tr>
      <th>{{ _('Last updated') }}</th>
      {% if status.status %}
        <td><span class="date" title="{{ h.render_datetime(status.last_updated, with_hours=True) }}">{{ h.time_ago_from_timestamp(status.last_updated) }}</span></td>
      {% else %}
        <td>{{ _('Never') }}</td>
      {% endif %}
    </tr>
    {% if status.task_info and status.task_info.error and status.task_info.error and status.task_info.error.response %}
      {% if status.task_info.error.response.error and status.task_info.error.response.error.__type %}
        <tr>
          <th>{{ _('Error type') }}</th>
          <td>{{ status.task_info.error.response.error.__type }}</td>
        </tr>
        <p>
        </p>
      {% endif %}
      {% if status.task_info.error.response.error and status.task_info.error.response.error.data %}
        <tr>
          <th>{{ _('Error info') }}</th>
          <td>{{ status.task_info.error.response.error.data }}</td>
        </tr>
        <p>
        </p>
      {% endif %}
      {% if status.task_info.error.response.error and status.task_info.error.response %}
      <tr class="toggle-more">
        <th>{{ _('Error Raw Response') }}</th>
        <td>{{ status.task_info.error.response }}</td>
      </tr>
      {% endif %}
    {% endif %}
  </table>

  {% if status.status and status.task_info and show_table %}
    <h3>{{ _('Upload Log') }}</h3>
    <ul class="activity">
      {% for item in status.task_info.logs %}
        {% set icon = 'ok' if item.level == 'INFO' else 'exclamation' %}
        {% set class = ' failure' if icon == 'exclamation' else ' success' %}
        {% set popover_content = 'test' %}
        <li class="item no-avatar{{ class }}">
          <i class="icon icon-{{ icon }}"></i>
          <p>
            {{ item.message | urlize }}<br>
            <span class="date" title="{{ h.render_datetime(item.timestamp, with_hours=True) }}">
              {{ h.time_ago_from_timestamp(item.timestamp) }}
              <a href="#" data-target="popover" data-content="<dl>{% for key, value in item.iteritems() %}<dt>{{ key }}</dt><dd>{{ value }}</dd>{% endfor %}</dl>" data-html="true">{{ _('Details') }}</a>
            </span>
          </p>
        </li>
      {% endfor %}
      <li class="item no-avatar">
        <i class="icon icon-info"></i>
        <p class="muted">{{ _('End of log') }}</p>
      </li>
    </ul>
  {% endif %}

{% endblock %}
