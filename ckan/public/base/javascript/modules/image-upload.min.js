this.ckan.module('image-upload',function($,_){return{options:{is_url:true,is_upload:false,field_upload:'image_upload',field_url:'image_url',field_clear:'clear_upload',upload_label:'',i18n:{upload:_('Upload'),url:_('Link'),remove:_('Remove'),upload_label:_('Image'),upload_tooltip:_('Upload a file on your computer'),url_tooltip:_('Link to a URL on the internet (you can also link to an API)')}},initialize:function(){$.proxyAll(this,/_on/);var options=this.options;var field_upload='input[name="'+options.field_upload+'"]';var field_url='input[name="'+options.field_url+'"]';var field_clear='input[name="'+options.field_clear+'"]';this.input=$(field_upload,this.el);this.field_url=$(field_url,this.el).parents('.form-group');this.field_image=this.input.parents('.form-group');this.field_url_input=$('input',this.field_url);var checkbox=$(field_clear,this.el);if(checkbox.length>0){options.is_upload=true;checkbox.parents('.form-group').remove();}
this.field_clear=$('<input type="hidden" name="clear_upload">').appendTo(this.el);this.button_url=$('<a href="javascript:;" class="btn"><i class="icon-globe"></i> '+this.i18n('url')+'</a>').prop('title',this.i18n('url_tooltip')).on('click',this._onFromWeb).insertAfter(this.input);this.button_upload=$('<a href="javascript:;" class="btn"><i class="icon-cloud-upload"></i>'+this.i18n('upload')+'</a>').insertAfter(this.input);$('<a href="javascript:;" class="btn btn-danger btn-remove-url"><i class="icon-remove"></i></a>').prop('title',this.i18n('remove')).on('click',this._onRemove).insertBefore(this.field_url_input);$('label[for="field-image-upload"]').text(options.upload_label||this.i18n('upload_label'));this.input.on('mouseover',this._onInputMouseOver).on('mouseout',this._onInputMouseOut).on('change',this._onInputChange).prop('title',this.i18n('upload_tooltip')).css('width',this.button_upload.outerWidth());this.fields=$('<i />').add(this.button_upload).add(this.button_url).add(this.input).add(this.field_url).add(this.field_image);if(options.is_url){this._showOnlyFieldUrl();}else if(options.is_upload){this._showOnlyFieldUrl();this.field_url_input.prop('readonly',true);}else{this._showOnlyButtons();}},_onFromWeb:function(){this._showOnlyFieldUrl();this.field_url_input.focus();if(this.options.is_upload){this.field_clear.val('true');}},_onRemove:function(){this._showOnlyButtons();this.field_url_input.val('');this.field_url_input.prop('readonly',false);this.field_clear.val('true');},_onInputChange:function(){var file_name=this.input.val().split(/^C:\\fakepath\\/).pop();this.field_url_input.val(file_name);this.field_url_input.prop('readonly',true);this.field_clear.val('');this._showOnlyFieldUrl();},_showOnlyButtons:function(){this.fields.hide();this.button_upload.add(this.field_image).add(this.button_url).add(this.input).show();},_showOnlyFieldUrl:function(){this.fields.hide();this.field_url.show();},_onInputMouseOver:function(){this.button_upload.addClass('hover');},_onInputMouseOut:function(){this.button_upload.removeClass('hover');}};});