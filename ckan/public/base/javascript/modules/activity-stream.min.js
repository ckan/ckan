this.ckan.module('activity-stream',function($,_){return{options:{more:null,id:null,context:null,offset:null,loading:false,i18n:{loading:_('Loading...')}},initialize:function(){$.proxyAll(this,/_on/);var options=this.options;options.more=(options.more=='True');this._onBuildLoadMore();$(window).on('scroll',this._onScrollIntoView);this._onScrollIntoView();},elementInViewport:function(el){var top=el.offsetTop;var left=el.offsetLeft;var width=el.offsetWidth;var height=el.offsetHeight;while(el.offsetParent){el=el.offsetParent;top+=el.offsetTop;left+=el.offsetLeft;}
return(top<(window.pageYOffset+window.innerHeight)&&left<(window.pageXOffset+window.innerWidth)&&(top+height)>window.pageYOffset&&(left+width)>window.pageXOffset);},_onScrollIntoView:function(){var el=$('.load-more a',this.el);if(el.length==1){var in_viewport=this.elementInViewport(el[0]);if(in_viewport&&!this.options.loading){el.trigger('click');}}},_onBuildLoadMore:function(){var options=this.options;if(options.more){$('.load-more',this.el).on('click','a',this._onLoadMoreClick);options.offset=$('.item',this.el).length;}},_onLoadMoreClick:function(event){event.preventDefault();var options=this.options;if(!options.loading){options.loading=true;$('.load-more a',this.el).html(this.i18n('loading')).addClass('disabled');this.sandbox.client.call('GET',options.context+'_activity_list_html','?id='+options.id+'&offset='+options.offset,this._onActivitiesLoaded);}},_onActivitiesLoaded:function(json){var options=this.options;var result=$(json.result);options.more=(result.data('module-more')=='True');options.offset+=30;$('.load-less',result).remove();$('.load-more',this.el).remove();$('li',result).appendTo(this.el);this._onBuildLoadMore();options.loading=false;}};});