var CKAN=CKAN||{};CKAN.View=CKAN.View||{};CKAN.Model=CKAN.Model||{};CKAN.Utils=CKAN.Utils||{};CKAN.Strings=CKAN.Strings||{};CKAN.Strings.errorLoadingPreview="Could not load preview";CKAN.Strings.errorDataProxy="DataProxy returned an error";CKAN.Strings.errorDataStore="DataStore returned an error";CKAN.Strings.previewNotAvailableForDataType="Preview not available for data type: ";(function($){$(document).ready(function(){CKAN.DataPreview.loadPreviewDialog(preload_resource);});}(jQuery));CKAN.DataPreview=function($,my){my.jsonpdataproxyUrl='http://jsonpdataproxy.appspot.com/';my.dialogId='ckanext-datapreview';my.$dialog=$('#'+my.dialogId);my.loadEmbeddedPreview=function(resourceData,reclineState){my.$dialog.html('<h4>Loading ... <img src="http://assets.okfn.org/images/icons/ajaxload-circle.gif" class="loading-spinner" /></h4>');var dataset=recline.Model.Dataset.restore(reclineState);var views=null;if(reclineState.currentView==='grid'){views=[{id:'grid',label:'Grid',view:new recline.View.SlickGrid({model:dataset,state:reclineState['view-grid']})}];}else if(reclineState.currentView==='graph'){views=[{id:'graph',label:'Graph',view:new recline.View.Graph({model:dataset,state:reclineState['view-graph']})}];}else if(reclineState.currentView==='map'){views=[{id:'map',label:'Map',view:new recline.View.Map({model:dataset,state:reclineState['view-map']})}];}
var dataExplorer=new recline.View.MultiView({el:my.$dialog,model:dataset,state:reclineState,views:views});};my.makeEmbedLink=function(explorerState){var state=explorerState.toJSON();state.state_version=1;var queryString='?';var items=[];$.each(state,function(key,value){if(typeof(value)==='object'){value=JSON.stringify(value);}
items.push(key+'='+escape(value));});queryString+=items.join('&');return embedPath+queryString;};my.loadPreviewDialog=function(resourceData){my.$dialog.html('<h4>Loading ... <img src="http://assets.okfn.org/images/icons/ajaxload-circle.gif" class="loading-spinner" /></h4>');function showError(msg){msg=msg||CKAN.Strings.errorLoadingPreview;return $('#ckanext-datapreview').append('<div></div>').addClass('alert alert-error fade in').html(msg);}
function initializeDataExplorer(dataset){var views=[{id:'grid',label:'Grid',view:new recline.View.SlickGrid({model:dataset})},{id:'graph',label:'Graph',view:new recline.View.Graph({model:dataset})},{id:'map',label:'Map',view:new recline.View.Map({model:dataset})}];var dataExplorer=new recline.View.MultiView({el:my.$dialog,model:dataset,views:views,config:{readOnly:true}});$('.menu-right a[data-action="fields"]').click();var embedLink=$('.embedLink');var embedIframeText=$('.embedIframeText');var iframeWidth=$('.iframe-width');var iframeHeight=$('.iframe-height');function updateLink(){var link=my.makeEmbedLink(dataExplorer.state);var width=iframeWidth.val();var height=iframeHeight.val();link+='&width='+width+'&height='+height;embedIframeText.val($.mustache('<iframe frameBorder="0" width="{{width}}" height="{{height}}" src="{{link}}"></iframe>',{link:link.replace(/"/g,'&quot;'),width:width,height:height}));embedLink.attr('href',link);}
dataExplorer.state.bind('change',updateLink);for(var i=0;i<dataExplorer.pageViews.length;i++){dataExplorer.pageViews[i].view.state.bind('change',updateLink);}
iframeWidth.change(updateLink);iframeHeight.change(updateLink);updateLink();$('.preview-header .btn').show();}
resourceData.formatNormalized=my.normalizeFormat(resourceData.format);resourceData.url=my.normalizeUrl(resourceData.url);if(resourceData.formatNormalized===''){var tmp=resourceData.url.split('/');tmp=tmp[tmp.length-1];tmp=tmp.split('?');tmp=tmp[0];var ext=tmp.split('.');if(ext.length>1){resourceData.formatNormalized=ext[ext.length-1];}}
if(resourceData.webstore_url){resourceData.url='/api/data/'+resourceData.id;resourceData.backend='elasticsearch';var dataset=new recline.Model.Dataset(resourceData);var errorMsg=CKAN.Strings.errorLoadingPreview+': '+CKAN.Strings.errorDataStore;dataset.fetch().done(function(dataset){initializeDataExplorer(dataset);}).fail(function(error){if(error.message)errorMsg+=' ('+error.message+')';showError(errorMsg);});}
else if(resourceData.formatNormalized in{'csv':'','xls':''}){resourceData.format=resourceData.formatNormalized;resourceData.backend='dataproxy';var dataset=new recline.Model.Dataset(resourceData);var errorMsg=CKAN.Strings.errorLoadingPreview+': '+CKAN.Strings.errorDataProxy;dataset.fetch().done(function(dataset){dataset.bind('query:fail',function(error){$('#ckanext-datapreview .data-view-container').hide();$('#ckanext-datapreview .header').hide();$('.preview-header .btn').hide();});initializeDataExplorer(dataset);$('.recline-query-editor .text-query').hide();}).fail(function(error){if(error.message)errorMsg+=' ('+error.message+')';showError(errorMsg);});}
else if(resourceData.formatNormalized in{'rdf+xml':'','owl+xml':'','xml':'','n3':'','n-triples':'','turtle':'','plain':'','atom':'','tsv':'','rss':'','txt':''}){var _url=my.jsonpdataproxyUrl+'?type=csv&url='+resourceData.url;my.getResourceDataDirect(_url,function(data){my.showPlainTextData(data);});}
else if(resourceData.formatNormalized in{'html':'','htm':''}||resourceData.url.substring(0,23)=='http://docs.google.com/'){my.$dialog.empty();var el=$('<iframe></iframe>');el.attr('src',resourceData.url);el.attr('width','100%');el.attr('height','100%');my.$dialog.append(el);}
else if(resourceData.formatNormalized in{'png':'','jpg':'','gif':''}||resourceData.resource_type=='image'){my.$dialog.empty();var el=$('<img />');el.attr('src',resourceData.url);el.css('max-width','100%');el.css('border','solid 4px black');my.$dialog.append(el);}
else{my.showError({title:CKAN.Strings.previewNotAvailableForDataType+resourceData.formatNormalized,message:''});}};my.getResourceDataDirect=function(url,callback){var timeout=5000;var timer=setTimeout(function error(){callback({error:{title:'Request Error',message:'Dataproxy server did not respond after '+(timeout/1000)+' seconds'}});},timeout);var jsonp='_callback';if(url.indexOf('jsonpdataproxy')!=-1){jsonp='callback';}
$.ajax({url:url,cache:true,dataType:'jsonp',jsonp:jsonp,success:function(data){clearTimeout(timer);callback(data);}});};my.showPlainTextData=function(data){if(data.error){my.showError(data.error);}else{var content=$('<pre></pre>');for(var i=0;i<data.data.length;i++){var row=data.data[i].join(',')+'\n';content.append(my.escapeHTML(row));}
my.$dialog.html(content);}};my.showError=function(error){var _html=_.template('<div class="alert alert-error"><strong><%= title %></strong><br /><%= message %></div>',error);my.$dialog.html(_html);};my.normalizeFormat=function(format){var out=format.toLowerCase();out=out.split('/');out=out[out.length-1];return out;};my.normalizeUrl=function(url){if(url.indexOf('https')===0){return'http'+url.slice(5);}else{return url;}}
my.escapeHTML=function(string){return string.replace(/&(?!\w+;|#\d+;|#x[\da-f]+;)/gi,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#x27').replace(/\//g,'&#x2F;');};$.extend(true,window,{CKANEXT:{}});CKANEXT.DATAPREVIEW=my;return my;}(jQuery,CKAN.DataPreview||{});