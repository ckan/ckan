#!/bin/bash

# Exit immediately if any command fails
set -e

# Setup postgres' users and databases
psql -c "CREATE USER ckan_default WITH PASSWORD 'pass';"
psql -c "CREATE USER datastore_default WITH PASSWORD 'pass';"
psql -c 'CREATE DATABASE ckan_test WITH OWNER ckan_default;'
psql -c 'CREATE DATABASE datastore_test WITH OWNER ckan_default;'

export PIP_USE_MIRRORS=true
pip install -r requirements.txt --allow-all-external
pip install -r dev-requirements.txt --allow-all-external

python setup.py develop

# Install npm dpes for mocha
npm install -g mocha-phantomjs@3.5.0 phantomjs@~1.9.1

paster db init -c test-core.ini

sed -i -e 's/.*datastore.read_url.*/ckan.datastore.read_url = postgresql:\/\/datastore_default:pass@\/datastore_test/' test-core.ini
paster datastore -c test-core.ini set-permissions | sudo -u postgres psql

cat test-core.ini
