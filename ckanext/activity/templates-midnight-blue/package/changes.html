{% extends "package/base.html" %}

{% block subtitle %}{{ pkg_dict.name }} {{ g.template_title_delimiter }} Changes {{ g.template_title_delimiter }} {{ super() }}{% endblock %}

{% block breadcrumb_content_selected %}{% endblock %}

{% block breadcrumb_content %}
  {{ super() }}
  <li>{% link_for _('Changes'), named_route='activity.package_activity', id=pkg_dict.name %}</li>
  <li class="active">{% link_for activity_diffs[0].activities[1].id|truncate(30), named_route='activity.package_changes', id=activity_diffs[0].activities[1].id %}</li>
{% endblock %}

{% block primary %}
  <article class="module">
    <div class="module-content">
      {% block package_changes_header %}
        <h1 class="page-heading">{{ _('Changes') }}</h1>
      {% endblock %}

      {% set select_list1 = h.activity_list_select(pkg_activity_list, activity_diffs[-1].activities[0].id) %}
      {% set select_list2 = h.activity_list_select(pkg_activity_list, activity_diffs[0].activities[1].id) %}

      {# HTML select macro for use below #}
      {% set old_select %}
        <label for="start_date" class="sr-only">{{ _("Start date") }}</label>
        <select class="form-control select-time" form="range_form" id="start_date" name="old_id">
          <pre>
            {{ select_list1[1:]|join }}
          </pre>
        </select>
      {% endset %}

      {% set new_select %}
        <label for="end_date" class="sr-only">{{ _("End date") }}</label>
        <select class="form-control select-time" form="range_form" id="end_date" name="new_id">
          <pre>
            {{ select_list2|join }}
          </pre>
        </select>
      {% endset %}

      <form id="range_form" action="{{ h.url_for('activity.package_changes_multiple') }}" data-module="select-switch" data-module-target="">
        <input type="hidden" name="current_old_id" value="{{ activity_diffs[-1].activities[0].id }}">
        <input type="hidden" name="current_new_id" value="{{ activity_diffs[0].activities[1].id }}">
        {# TRANSLATORS: old_select and new_select are placeholders for HTML select elements for choosing the range of changes to view #}
        {% trans %}View changes from {{ old_select }} to {{ new_select }}{% endtrans %}
      </form>

        <br>

      {# iterate through the list of activity diffs #}
      <hr>
      {% for i in range(activity_diffs|length) %}
        {% snippet "package/snippets/change_item.html", activity_diff=activity_diffs[i], pkg_dict=pkg_dict %}

        {# TODO: display metadata for more than most recent change #}
        {% if i == 0 %}
          {# button to show JSON metadata diff for the most recent change - not shown by default #}
          <input type="button" data-module="metadata-button" data-module-target="" class="btn btn-primary-outline" value="{{ _('Show metadata diff') }}" id="metadata_button" data-show-text="{{ _('Show metadata diff') }}" data-hide-text="{{ _('Hide metadata diff') }}"></input>
          <div id="metadata_diff" style="display:none;">
          {% block package_changes_diff %}
            <pre>
              {{ activity_diffs[0]['diff']|safe }}
            </pre>
          {% endblock %}
          </div>
        {% endif %}

        <hr>
      {% endfor %}
    </div>
  </article>
{% endblock %}

{% block secondary %}{% endblock %}
