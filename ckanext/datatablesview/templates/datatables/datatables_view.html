{% extends "base.html" %}

{% block title %}{{ h.dataset_display_name(package)}}&mdash;{{ h.resource_display_name(resource)}} - {{ super() }}{% endblock %}

{% block bodytag %}
  {{- super() -}}
  class="dt-view"
{%- endblock -%}

{%- block page -%}

  {%- set nbspval = "&nbsp;"|safe -%}
  {% set can_edit = h.check_access('resource_update', {'id': resource_id}) %}
  {%- set data_dictionary = h.datastore_dictionary(resource.id, resource_view.get('show_fields')) -%}

  <table
    id="dtprv"
    width="100%"
    class="table table-striped table-striped-reverse table-bordered table-condensed table-hover datatables-pre-render-hidden"
    data-module="datatables_view"
    data-module-state-save-flag='{{ state_saving|tojson }}'
    data-module-state-duration="{{ state_duration }}"
    data-module-ellipsis-length="{{ resource_view.ellipsis_length if resource_view.ellipsis_length is defined else ellipsis_length }}"
    data-module-date-format="{{ resource_view.date_format if resource_view.date_format is defined else date_format }}"
    data-module-package-name="{{ package.name }}"
    data-module-resource-name="{{ h.resource_display_name(resource) }}"
    data-module-view-id="{{ resource_view.id }}"
    data-module-language-code="{{ h.lang() }}"
    data-module-language-object='{{ language_object or "null" }}'
    data-module-ajax-url="{{ h.url_for('datatablesview.ajax', resource_view_id=resource_view.id) }}"
    data-module-ckan-filters='{{ request.args.get("filters", "")|e or "null" }}'
    data-module-responsive-flag="{{ resource_view.get('responsive')|lower }}"
    data-module-page-length-choices="{{ page_length_choices }}"
    data-module-responsive-modal="{{ responsive_modal|lower }}"
    data-module-resource-url="{{ h.url_for(package.type ~ '_resource.read', id=package.name, resource_id=resource.id ) }}"
    data-module-data-dictionary='{{- data_dictionary|tojson -}}'
    data-module-editable='{{ can_edit|tojson }}'
    data-module-timeout="{{ request_timeout }}"
  >
    <thead>
      <tr>
        <th class="all" data-name="_id">_id</th>
        {% for field in data_dictionary -%}
          <th scope="col">
            {%- if data_dictionary_labels and field.info is defined and field.info.label|length -%}
              {{ field.info.label|replace(" ", nbspval) }}
            {%- else -%}
              {{ field.id|replace(" ", nbspval) }}
            {%- endif -%}
            &nbsp;
            {%- if data_dictionary_labels and field.info is defined and (field.info.label|length or field.info.notes|length)-%}
              <i class="fa fa-info-circle" title="{{field.id}} ({{field.type}})&#10;{{ h.markdown_extract(field.info.notes, 300) }}"></i>
            {%- endif -%}
            &nbsp;
          </th>
        {% endfor -%}
      </tr>
    </thead>
    <tbody id="dtprv-body-main"></tbody>
    <tfoot id="dtprv-foot-main"></tfoot>
  </table>

  <form id="filtered-datatables-download" method="POST"
        action="{{- h.url_for('datatablesview.filtered_download', resource_view_id=resource_view.id) -}}">
    {{ h.csrf_input() }}
    <input type="hidden" name="filters" value="{{ request.args.get('filters', '')|e -}}" />
  </form>

{%- endblock -%}

{%- block styles -%}
  {{- super() -}}

  {# NOTE: need inline visibility to fully prevent load flashing in datatables #}
  <style>
    body .datatables-pre-render-hidden{
      visibility: hidden;
    }
  </style>

  {% asset 'ckanext-datatablesview/main-css' %}
  {% asset 'ckanext-datatablesview/main-js' %}
{% endblock %}

{% block custom_styles %}{% endblock %}
