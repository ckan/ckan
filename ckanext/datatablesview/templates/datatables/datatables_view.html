{# NOTE: need inline visibility to fully prevent load flashing in datatables #}
<style>
  body .datatables-pre-render-hidden{
    visibility: hidden;
  }
  body #dtv-resource-info,
  body #dtv-resource-info .dtv-resource-info-content{
    display: none;
  }
</style>

{% asset 'ckanext-datatablesview/main-css' %}
{% asset 'ckanext-datatablesview/main-js' %}

{%- set nbspval = "&nbsp;"|safe -%}
{% set can_edit = h.check_access('resource_update', {'id': resource_id}) %}
{%- set data_dictionary = h.datastore_dictionary(resource.id, resource_view.get('show_fields')) -%}

<div class="dt-view-wrapper" data-fullscreen='{{ fullscreen|tojson }}'>
  {# NOTE: tojson filters and json objects need single quotes! #}
  <table
    id="dtprv"
    width="100%"
    class="table table-striped table-striped-reverse table-bordered table-condensed table-hover datatables-pre-render-hidden"
    data-module="datatables_view"
    data-module-state-save-flag='{{ state_saving|tojson }}'
    data-module-state-duration="{{ state_duration }}"
    data-module-ellipsis-length="{{ resource_view.ellipsis_length if resource_view.ellipsis_length is defined else ellipsis_length }}"
    data-module-date-format="{{ resource_view.date_format if resource_view.date_format is defined else date_format }}"
    data-module-package-name="{{ package.name }}"
    data-module-resource-name="{{ h.resource_display_name(resource) }}"
    data-module-created-date="{{ h.render_datetime(resource.created, date_format='%Y-%m-%dT%H:%M:%S%z') }}"
    data-module-data-updated-date="{{ h.render_datetime(resource.last_modified, date_format='%Y-%m-%dT%H:%M:%S%z') }}"
    data-module-metadata-updated-date="{{ h.render_datetime(resource.metadata_modified, date_format='%Y-%m-%dT%H:%M:%S%z') }}"
    data-module-resource-format="{{ resource.format or resource.mimetype_inner or resource.mimetype or _('unknown') }}"
    data-module-resource-file-size="{{ resource.size }}"
    data-module-resource-file-size-humanized='{{ h.localised_filesize(resource.size) or "null" }}'
    data-module-view-id="{{ resource_view.id }}"
    data-module-language-code="{{ h.lang() }}"
    data-module-language-object='{{ language_object or "null" }}'
    data-module-ajax-url="{{ h.url_for('datatablesview.ajax', resource_view_id=resource_view.id) }}"
    data-module-ckan-filters='{{ request.args.get("filters", "")|e or "null" }}'
    data-module-responsive-flag='{{ resource_view.get('responsive')|tojson }}'
    data-module-page-length-choices="{{ page_length_choices }}"
    data-module-resource-url="{{ h.url_for(package.type ~ '_resource.read', id=package.name, resource_id=resource.id ) }}"
    data-module-data-dictionary='{{- data_dictionary|tojson -}}'
    data-module-editable='{{ can_edit|tojson }}'
    data-module-timeout="{{ request_timeout }}"
  >
    <thead>
      <tr>
        <th class="all" data-name="_id" data-ds-type="int">_id</th>
        {% for field in data_dictionary -%}
          <th scope="col" data-name="{{- field.id -}}" data-ds-type="{{- field.type -}}">
            {%- if data_dictionary_labels and field.info is defined and field.info.label|length -%}
              {{- field.info.label|replace(" ", nbspval) -}}
            {%- else -%}
              {{- field.id|replace(" ", nbspval) -}}
            {%- endif -%}
            {{- nbspval -}}
            {%- if data_dictionary_labels and field.info is defined and (field.info.label|length or field.info.notes|length) -%}
              <i class="fa fa-info-circle" title="{{field.id}} ({{field.type}})&#10;{{ h.markdown_extract(field.info.notes, 300) }}"></i>
            {%- endif -%}
            {{- nbspval -}}
          </th>
        {% endfor -%}
      </tr>
    </thead>
    <tbody id="dtprv-body-main"></tbody>
    <tfoot id="dtprv-foot-main"></tfoot>
  </table>

  <form id="filtered-datatables-download" method="POST"
        action="{{- h.url_for('datatablesview.filtered_download', resource_view_id=resource_view.id) -}}">
    {{ h.csrf_input() }}
    <input type="hidden" name="filters" value="{{ request.args.get('filters', '')|e -}}" />
  </form>

  {#- we do this macro instead of the snippet because the snippet pollutes the output with comments/whitespaces which #}
  {# may be invisible for regular html, but not for tooltips -#}
  {%- macro local_friendly_datetime(dt_obj) -%}
    <span class="automatic-local-datetime" data-datetime="{{ h.render_datetime(dt_obj, date_format='%Y-%m-%dT%H:%M:%S%z') }}">
      {{- h.render_datetime(dt_obj, with_hours=True) -}}
    </span>
  {%- endmacro -%}

  {#- we create tooltip here instead of javascript so we can leverage the automatic-local-datetime class date conversion CKAN does -#}
  {%- set res = resource %}
  <div id="dtv-resource-info">
    <a href="{{- h.url_for(package.type ~ '_resource.read', id=package.name, resource_id=resource.id ) -}}">
      {{ package.name }} &mdash; {{ h.resource_display_name(resource) }}
    </a>&nbsp;<i class="fa fa-info-circle"></i>
    <div class="dtv-resource-info-content">
      {{- _('Data last updated:') }} {{ local_friendly_datetime(res.last_modified) }}&#10;
      {{- _('Metadata last updated:') }} {{ local_friendly_datetime(res.metadata_modified) }}&#10;
      {{- _('Created:') }} {{ local_friendly_datetime(res.created) }}&#10;
      {{- _('Format:') }} {{ res.format or res.mimetype_inner or res.mimetype or _('unknown') -}}&#10;
      {%- if res.size and res.size|int != 0 -%}
        {{- _('File size:') }} {{ h.localised_filesize(res.size)}}
      {%- endif -%}
    </div>
  </div>
</div>
